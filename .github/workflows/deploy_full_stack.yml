# Deploy Full Stack - Refactored to use modular bash scripts
# See infrastructure/scripts/ for provisioning logic
name: Deploy Full Stack

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  VM_NAME: ${{ vars.GCP_VM_NAME || 'theatre-vm' }}
  MACHINE_TYPE: e2-medium
  IMAGE_FAMILY: debian-12
  IMAGE_PROJECT: debian-cloud
  BOOT_DISK_SIZE: 20GB
  CLOUD_INIT_FILE: infrastructure/cloud-init.yaml
  MEDIA_DISK_NAME: ${{ vars.GCP_MEDIA_DISK_NAME || 'theatre-media-disk' }}
  MEDIA_DISK_SIZE: 200GB
  MEDIA_DISK_TYPE: pd-standard
  SCRIPTS_DIR: /opt/theatre/scripts

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Ensure media disk exists
        run: |
          gcloud compute disks describe "${MEDIA_DISK_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --quiet 2>/dev/null || \
          gcloud compute disks create "${MEDIA_DISK_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --size="${MEDIA_DISK_SIZE}" --type="${MEDIA_DISK_TYPE}"

      - name: Ensure VM exists
        run: |
          gcloud compute instances describe "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --quiet 2>/dev/null || \
          gcloud compute instances create "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" \
            --machine-type="${MACHINE_TYPE}" --image-family="${IMAGE_FAMILY}" --image-project="${IMAGE_PROJECT}" \
            --boot-disk-size="${BOOT_DISK_SIZE}" --metadata-from-file=user-data="${CLOUD_INIT_FILE}" --tags=http-server,https-server

      - name: Ensure media disk is attached
        run: |
          gcloud compute instances describe "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --format="value(disks[].source)" | grep -q "${MEDIA_DISK_NAME}" || \
          gcloud compute instances attach-disk "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --disk="${MEDIA_DISK_NAME}" --device-name=media-disk

      - name: Ensure VM is running and get IP
        id: vm
        run: |
          STATUS=$(gcloud compute instances describe "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --format="value(status)")
          if [ "${STATUS}" != "RUNNING" ]; then
            gcloud compute instances start "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}"
            for i in {1..12}; do
              [ "$(gcloud compute instances describe "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --format="value(status)" 2>/dev/null)" = "RUNNING" ] && break
              sleep 5
            done
          fi
          echo "ip=$(gcloud compute instances describe "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --format="value(networkInterfaces[0].accessConfigs[0].natIP)")" >> "$GITHUB_OUTPUT"

      - name: Wait for SSH
        run: |
          for i in {1..30}; do
            gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command="true" --quiet 2>/dev/null && break
            echo "Waiting for SSH (${i}/30)..." && sleep 10
          done

      - name: Upload provisioning scripts
        run: |
          gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command="sudo mkdir -p ${SCRIPTS_DIR}" --quiet
          gcloud compute scp infrastructure/scripts/*.sh "${VM_NAME}:${SCRIPTS_DIR}/" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --quiet
          gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command="sudo chmod +x ${SCRIPTS_DIR}/*.sh" --quiet

      - name: Upload secrets and run provisioning
        run: |
          cat > /tmp/secrets.env << EOF
          GOCRYPTFS_PASSWORD=${GOCRYPTFS_PASSWORD}
          DUCKDNS_TOKEN=${DUCKDNS_TOKEN}
          DUCKDNS_DOMAIN=${DUCKDNS_DOMAIN}
          DOMAIN_NAME=${DOMAIN_NAME}
          REPO_URL=https://github.com/${{ github.repository }}.git
          EOF
          chmod 600 /tmp/secrets.env
          gcloud compute scp /tmp/secrets.env "${VM_NAME}:/tmp/secrets.env" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --quiet
          rm -f /tmp/secrets.env
          gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command="
            set -euo pipefail
            sudo chmod 600 /tmp/secrets.env
            set -a && source /tmp/secrets.env && set +a
            rm -f /tmp/secrets.env
            sudo -E ${SCRIPTS_DIR}/ensure_disk.sh
            sudo -E ${SCRIPTS_DIR}/ensure_disk_mount.sh
            sudo -E ${SCRIPTS_DIR}/ensure_docker_installed.sh
            sudo -E ${SCRIPTS_DIR}/migrate_docker_root.sh
            sudo -E ${SCRIPTS_DIR}/ensure_gocryptfs.sh
            sudo -E ${SCRIPTS_DIR}/ensure_repo_clone.sh
            sudo -E ${SCRIPTS_DIR}/ensure_duckdns.sh
            sudo -E ${SCRIPTS_DIR}/ensure_env_file.sh
            sudo -E ${SCRIPTS_DIR}/ensure_compose_cleanup.sh
            sudo -E ${SCRIPTS_DIR}/start_compose.sh
          "
        env:
          GOCRYPTFS_PASSWORD: ${{ secrets.GOCRYPTFS_PASSWORD }}
          DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}
          DUCKDNS_DOMAIN: ${{ vars.DUCKDNS_DOMAIN }}
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}

      - name: Verify deployment
        id: verify
        run: |
          gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command="
            sudo ${SCRIPTS_DIR}/verify_mounts.sh
            sudo ${SCRIPTS_DIR}/verify_jellyfin_mount.sh
            sudo ${SCRIPTS_DIR}/verify_caddy.sh
          "
          echo "media=$(gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command='mountpoint -q /mnt/disks/media && echo MOUNTED || echo NOT_MOUNTED' --quiet)" >> "$GITHUB_OUTPUT"
          echo "gocryptfs=$(gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command='mountpoint -q /srv/library_clear && echo MOUNTED || echo NOT_MOUNTED' --quiet)" >> "$GITHUB_OUTPUT"
          echo "jellyfin=$(gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command='docker inspect --format="{{.State.Status}}" jellyfin 2>/dev/null || echo NOT_RUNNING' --quiet)" >> "$GITHUB_OUTPUT"
          echo "caddy=$(gcloud compute ssh "${VM_NAME}" --project="${{ secrets.GCP_PROJECT_ID }}" --zone="${{ secrets.GCP_ZONE }}" --command='docker inspect --format="{{.State.Status}}" caddy 2>/dev/null || echo NOT_RUNNING' --quiet)" >> "$GITHUB_OUTPUT"

      - name: Verify HTTPS
        id: https
        if: vars.DOMAIN_NAME != ''
        run: |
          sleep 10
          for i in {1..12}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "https://${{ vars.DOMAIN_NAME }}" || echo "FAILED")
            [ "${STATUS}" = "200" ] || [ "${STATUS}" = "302" ] && break
            echo "Waiting for HTTPS (${i}/12)..." && sleep 10
          done
          echo "status=${STATUS}" >> "$GITHUB_OUTPUT"

      - name: Print deployment summary
        run: |
          echo "============================================================"
          echo "                 DEPLOYMENT SUMMARY"
          echo "============================================================"
          echo "VM: ${VM_NAME} (${{ steps.vm.outputs.ip }})"
          echo "Mounts: media=${{ steps.verify.outputs.media }}, gocryptfs=${{ steps.verify.outputs.gocryptfs }}"
          echo "Containers: jellyfin=${{ steps.verify.outputs.jellyfin }}, caddy=${{ steps.verify.outputs.caddy }}"
          echo "HTTPS: ${{ steps.https.outputs.status || 'SKIPPED' }}"
          echo "============================================================"
          [ -n "${{ vars.DOMAIN_NAME }}" ] && echo "ðŸŽ¬ Visit: https://${{ vars.DOMAIN_NAME }}" || echo "ðŸŽ¬ Visit: http://${{ steps.vm.outputs.ip }}:8096"
          echo "============================================================"
